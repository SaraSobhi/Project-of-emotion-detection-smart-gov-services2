{% extends "base.html" %}

{% block title %}Admin Dashboard - GovCare{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">
                    Admin <span class="text-smart-blue-400">Dashboard</span>
                </h1>
                <p class="text-gray-300">Welcome back, {{ username }}!</p>
            </div>
            <a href="/admin/export"
                class="inline-flex items-center justify-center px-6 py-3 btn-primary text-white font-semibold rounded-xl space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <span>Export XLSX</span>
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        <div class="glass-effect rounded-xl p-6 hover-lift">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Total Feedbacks</p>
                    <p class="text-3xl font-bold text-white mt-2" id="total-count">{{ feedbacks|length }}</p>
                </div>
                <div class="w-12 h-12 bg-smart-blue-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-smart-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-effect rounded-xl p-6 hover-lift">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Positive</p>
                    <p class="text-3xl font-bold text-green-400 mt-2" id="positive-count">0</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5">
                        </path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-effect rounded-xl p-6 hover-lift">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Negative</p>
                    <p class="text-3xl font-bold text-red-400 mt-2" id="negative-count">0</p>
                </div>
                <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5">
                        </path>
                    </svg>
                </div>
            </div>
        </div>


    </div>

    <!-- Filters and Chart Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Filters -->
        <div class="glass-effect rounded-xl p-6">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center space-x-2">
                <svg class="w-5 h-5 text-smart-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                    </path>
                </svg>
                <span>Filters</span>
            </h2>

            <div class="space-y-4">
                <div>
                    <label for="date-filter" class="block text-sm font-semibold text-gray-200 mb-2">
                        Filter by Date
                    </label>
                    <input type="date" id="date-filter"
                        class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-smart-blue-500 focus:border-transparent transition-all duration-200" />
                </div>

                <div>
                    <label for="sentiment-filter" class="block text-sm font-semibold text-gray-200 mb-2">
                        Filter by Sentiment
                    </label>
                    <select id="sentiment-filter"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-smart-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">All</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>

                <button onclick="resetFilters()"
                    class="w-full px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 text-white font-medium rounded-lg transition-all duration-200">
                    Reset Filters
                </button>
            </div>
        </div>

        <!-- Chart -->
        <div class="lg:col-span-2 glass-effect rounded-xl p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
                <h2 class="text-xl font-bold text-white flex items-center space-x-2">
                    <svg class="w-5 h-5 text-smart-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                    </svg>
                    <span>Distribution Chart</span>
                </h2>

                <select id="chart-column" onchange="updateChart()"
                    class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-smart-blue-500 focus:border-transparent transition-all duration-200">
                    <option value="sentiment">By Sentiment</option>
                    <option value="has_negation">By Negation</option>
                </select>
            </div>

            <div class="h-64 flex items-center justify-center">
                <canvas id="feedbackChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Feedbacks Table -->
    <div class="glass-effect rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center space-x-2">
            <svg class="w-5 h-5 text-smart-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span>All Feedbacks</span>
        </h2>

        <div class="overflow-x-auto">
            <table class="w-full" id="feedbacks-table">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="text-left py-3 px-4 text-gray-300 font-semibold text-sm">Date</th>
                        <th class="text-left py-3 px-4 text-gray-300 font-semibold text-sm">Feedback</th>
                        <th class="text-left py-3 px-4 text-gray-300 font-semibold text-sm">Sentiment</th>
                        <th class="text-left py-3 px-4 text-gray-300 font-semibold text-sm">Confidence</th>
                        <th class="text-left py-3 px-4 text-gray-300 font-semibold text-sm">Negation</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% if feedbacks %}
                    {% for fb in feedbacks %}
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors duration-150 feedback-row"
                        data-id="{{ fb.id }}" data-date="{{ fb.created_at }}" data-sentiment="{{ fb.sentiment or '' }}">
                        <td class="py-3 px-4 text-gray-300 text-sm">
                            {{ fb.created_at.strftime('%Y-%m-%d %H:%M') if fb.created_at else 'N/A' }}
                        </td>
                        <td class="py-3 px-4 text-white max-w-md">
                            <div class="line-clamp-2">{{ fb.feedback }}</div>
                        </td>
                        <td class="py-3 px-4">
                            {% if fb.sentiment == 'Positive' %}
                            <span
                                class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-semibold">Positive</span>
                            {% elif fb.sentiment == 'Negative' %}
                            <span
                                class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-xs font-semibold">Negative</span>
                            {% else %}
                            <span
                                class="px-3 py-1 bg-gray-500/20 text-gray-400 rounded-full text-xs font-semibold">Unknown</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-gray-300 text-sm">
                            {{ "%.2f"|format(fb.confidence * 100) if fb.confidence else 'N/A' }}%
                        </td>
                        <td class="py-3 px-4 text-gray-300 text-sm">
                            {% if fb.has_negation %}
                            <span class="text-orange-400">Yes</span>
                            {% elif fb.has_negation == False %}
                            <span class="text-gray-500">No</span>
                            {% else %}
                            <span class="text-gray-500">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="py-8 text-center text-gray-400">
                            No feedbacks yet
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Store all feedbacks data
    const feedbacksData = {{ feedbacks| tojson }};

    // Calculate sentiment counts
    function calculateSentimentCounts(data) {
        const counts = { positive: 0, negative: 0, unknown: 0 };
        data.forEach(fb => {
            const sentiment = fb.sentiment ? fb.sentiment.toLowerCase() : 'unknown';
            if (sentiment === 'positive' || sentiment === 'negative') {
                counts[sentiment] = (counts[sentiment] || 0) + 1;
            } else {
                counts.unknown = (counts.unknown || 0) + 1;
            }
        });
        return counts;
    }

    // Update stats
    function updateStats(data) {
        const counts = calculateSentimentCounts(data);
        document.getElementById('total-count').textContent = data.length;
        document.getElementById('positive-count').textContent = counts.positive || 0;
        document.getElementById('negative-count').textContent = counts.negative || 0;
    }

    // Initialize stats
    updateStats(feedbacksData);

    // Chart instance
    let chartInstance = null;

    // Update chart based on selected column
    function updateChart() {
        const column = document.getElementById('chart-column').value;
        const ctx = document.getElementById('feedbackChart').getContext('2d');

        let labels = [];
        let data = [];
        let colors = [];

        if (column === 'sentiment') {
            const counts = calculateSentimentCounts(feedbacksData);
            labels = ['Positive', 'Negative', 'Unknown'];
            data = [counts.positive || 0, counts.negative || 0, counts.unknown || 0];
            colors = ['#4ade80', '#f87171', '#9ca3af'];
        } else if (column === 'has_negation') {
            let hasNeg = 0, noNeg = 0, unknown = 0;
            feedbacksData.forEach(fb => {
                if (fb.has_negation === true) hasNeg++;
                else if (fb.has_negation === false) noNeg++;
                else unknown++;
            });
            labels = ['Has Negation', 'No Negation', 'Unknown'];
            data = [hasNeg, noNeg, unknown];
            colors = ['#fb923c', '#60a5fa', '#9ca3af'];
        }

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#d1d5db',
                            padding: 15,
                            font: {
                                size: 12,
                                family: 'Inter'
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize chart
    updateChart();

    // Date filter
    document.getElementById('date-filter').addEventListener('change', function () {
        filterTable();
    });

    // Sentiment filter
    document.getElementById('sentiment-filter').addEventListener('change', function () {
        filterTable();
    });

    // Filter table
    function filterTable() {
        const dateFilter = document.getElementById('date-filter').value;
        const sentimentFilter = document.getElementById('sentiment-filter').value.toLowerCase();
        const rows = document.querySelectorAll('.feedback-row');

        let visibleData = [];

        rows.forEach(row => {
            const rowDate = row.getAttribute('data-date');
            const rowSentiment = row.getAttribute('data-sentiment').toLowerCase();
            const rowId = row.getAttribute('data-id');

            let showRow = true;

            // Date filter
            if (dateFilter && rowDate) {
                const rowDateOnly = rowDate.split(' ')[0];
                if (!rowDateOnly.startsWith(dateFilter)) {
                    showRow = false;
                }
            }

            // Sentiment filter
            if (sentimentFilter && rowSentiment !== sentimentFilter) {
                showRow = false;
            }

            if (showRow) {
                row.style.display = '';
                // Find matching feedback data using ID
                const fbData = feedbacksData.find(fb => fb.id === rowId);
                if (fbData) visibleData.push(fbData);
            } else {
                row.style.display = 'none';
            }
        });

        // Update stats based on visible data
        updateStats(visibleData);
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('date-filter').value = '';
        document.getElementById('sentiment-filter').value = '';
        filterTable();
    }
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Dropdown option styling */
    select option {
        background-color: #334155;
        color: white;
    }
</style>
{% endblock %}